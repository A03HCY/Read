<!doctype html>
<html lang="zh-cmn-Hans">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, shrink-to-fit=no" />
    <meta name="renderer" content="webkit" />
    <meta name="force-rendering" content="webkit" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <link rel="stylesheet" href="https://unpkg.com/mdui@1.0.2/dist/css/mdui.min.css" />
    <title>Read Book</title>
</head>

<body class="mdui-drawer-body-left">
    <div class="mdui-appbar mdui-shadow-0">
        <div class="mdui-toolbar">
            <a href="javascript:;" class="mdui-btn mdui-btn-icon mdui-ripple" mdui-drawer="{target: '#drawer'}">
                <i class="mdui-icon material-icons">menu</i>
            </a>
            <a href="javascript:;" id="title" class="mdui-typo-title">Title</a>
            <div class="mdui-toolbar-spacer"></div>
            <a href="javascript:;" class="mdui-btn mdui-btn-icon mdui-ripple">
                <i class="mdui-icon material-icons">search</i>
            </a>
            <a href="javascript:;" class="mdui-btn mdui-btn-icon mdui-ripple">
                <i class="mdui-icon material-icons">link</i>
            </a>
            <a href="javascript:;" class="mdui-btn mdui-btn-icon mdui-ripple">
                <i class="mdui-icon material-icons">more_vert</i>
            </a>
        </div>
    </div>
    <div class="mdui-drawer" id="drawer">
        <ul class="mdui-list" id="menu" mdui-collapse="{accordion: true}"></ul>
    </div>
    <div class="mdui-container">
        <article class="mdui-typo"></article>
    </div>

    <script src="https://unpkg.com/mdui@1.0.2/dist/js/mdui.min.js"></script>
    <script src="https://unpkg.com/showdown/dist/showdown.min.js"></script>
    <script>
        let $ = mdui.$;
        let P = '';

        test = {
            "Chaper.1": {
                "title 1.1": {
                    "md": "url 1.1"
                },
                "title 1.2": {
                    "md": "url 1.2"
                }
            },
            "Chaper.2": {
                "title 2.1": {
                    "md": "url 2.1"
                }
            },
            "Chaper.end-SINGLE": 'https://core.acdp.top/README.md'
        }

        String.prototype.nReplace = function (f, e) {
            let reg = new RegExp(f, "g");
            return this.replace(reg, e);
        }

        function Randomcode(length) {
            let chars = '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ'
            let result = '';
            for (var i = length; i > 0; --i) result += chars[Math.floor(Math.random() * chars.length)];
            return result;
        }

        function Converter(mark) {
            let converter = new showdown.Converter();
            return converter.makeHtml(mark)
        }

        function CreatTitle(chapter, cid) {
            let html = ''
            for (var title in chapter) {
                html += '<li onclick="Read(this)" md="' + chapter[title]['md'] + '" class="mdui-list-item mdui-ripple">' + title + '</li>'
            }
            return html
        }

        function CreatChapter(data, mid) {
            let html = '';
            for (var chapter in data) {
                if (chapter.includes('-SINGLE')) {
                    let schapter = chapter.nReplace('-SINGLE', '')
                    html += '<li onclick="Read(this)" md="' + data[chapter] + '" class="mdui-list-item mdui-ripple"><i class="mdui-list-item-icon mdui-icon material-icons">bookmark_border</i><div class="mdui-list-item-content">' + schapter + '</div></li>'
                } else {
                    html += '<li class="mdui-collapse-item"><div class="mdui-collapse-item-header mdui-list-item mdui-ripple"><i class="mdui-list-item-icon mdui-icon material-icons">bookmark_border</i><div class="mdui-list-item-content">' + chapter + '</div><i class="mdui-collapse-item-arrow mdui-icon material-icons">keyboard_arrow_down</i></div><ul class="mdui-collapse-item-body mdui-list mdui-list-dense">' + CreatTitle(data[chapter]) + '</ul></li>'
                }
            }
            return html
        }

        function CreatMenu(meta, hid) {
            let data;
            if (typeof (meta) == 'string') {
                data = JSON.parse(meta);
                console.log('if');
            } else {
                data = meta;
            }
            let html = CreatChapter(data)
            document.getElementById(hid).innerHTML = html;
        }

        function Inactive(hid) {
            $('.mdui-list-item-active').removeClass('mdui-list-item-active')
        }

        function Read(e) {
            Inactive('menu');
            $(e).addClass('mdui-list-item-active');
            $('#title').html($(e).text().nReplace('bookmark_border', ''));
            Loadanime();
            let innerH = Randomcode(4);
            P = innerH;
            LoadMarkdown($(e).attr('md'), innerH)
        }

        function LoadMarkdown(url, code) {
            $.ajax({
                method: 'GET',
                url: url,
                success: function (data) {
                    let converter = new showdown.Converter();
                    let html = converter.makeHtml(data);
                    if (P == code) {
                        $('article').html(html)
                    }
                },
                error: function (xhr, textStatus) {
                    if (P == code) {
                        $('article').html('Fail to load')
                    }
                }
            });
        }

        function Loadanime() {
            $('article').html('<div class="mdui-spinner mdui-spinner-colorful mdui-center" style="margin-top:25vh;"></div><div class="subheading mdui-text-center mdui-m-t-2">正在读取</div>')
            mdui.mutation()
        }

        CreatMenu(test, 'menu')

    </script>
</body>

</html>